#!/usr/bin/env python3
"""
Ø³ÙƒØ±Ø¨Øª ÙƒØ§Ù…Ù„ Ù„ØªÙˆÙ„ÙŠØ¯ ØµÙØ­Ø§Øª Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª ÙˆØ±ÙØ¹Ù‡Ø§ Ø¹Ù„Ù‰ GitHub Ù…Ø¨Ø§Ø´Ø±Ø©
ÙŠØªØ¹Ø§Ù…Ù„ Ù…Ø¹ GitHub API Ù„Ø±ÙØ¹ Ø§Ù„Ù…Ù„ÙØ§Øª ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹
"""

import json
import re
import os
import base64
import requests
from datetime import datetime
from urllib.parse import quote

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù…Ø´Ø±ÙˆØ¹
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
GITHUB_TOKEN = os.environ.get('GITHUB_TOKEN', '')  # Ø¶Ø¹ Ø§Ù„ØªÙˆÙƒÙ† ÙÙŠ Ù…ØªØºÙŠØ± Ø§Ù„Ø¨ÙŠØ¦Ø©
GITHUB_REPO = "sherow1982/alsooq-alsaudi"
GITHUB_BRANCH = "main"
WHATSAPP_NUMBER = "201110760081"
PRODUCTS_FILE = "products.json"
OUTPUT_DIR = "products"

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# Ø¯ÙˆØ§Ù„ Ù…Ø³Ø§Ø¹Ø¯Ø©
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

def create_slug(title):
    """Ø¥Ù†Ø´Ø§Ø¡ slug Ù…Ù† Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬"""
    slug = title.strip().replace(' ', '-')
    slug = re.sub(r'[<>:"/\\|?*]', '', slug)
    return slug

def generate_product_html(product):
    """ØªÙˆÙ„ÙŠØ¯ ØµÙØ­Ø© HTML Ù„Ù…Ù†ØªØ¬ ÙˆØ§Ø­Ø¯"""
    slug = create_slug(product['title'])
    discount = product['price'] - product['sale_price']
    discount_percentage = int((discount / product['price']) * 100) if product['price'] > 0 else 0

    encoded_slug = quote(slug)
    product_url = f"https://{GITHUB_REPO.split('/')[0]}.github.io/{GITHUB_REPO.split('/')[1]}/products/{encoded_slug}.html"

    html = f"""<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="{product['title']} - Ø§Ù„Ø³Ø¹Ø± {product['sale_price']} Ø±ÙŠØ§Ù„ Ø¨Ø¯Ù„Ø§Ù‹ Ù…Ù† {product['price']} Ø±ÙŠØ§Ù„">
    <meta property="og:title" content="{product['title']}">
    <meta property="og:description" content="Ø³Ø¹Ø± Ø®Ø§Øµ {product['sale_price']} Ø±ÙŠØ§Ù„ Ø¨Ø¯Ù„Ø§Ù‹ Ù…Ù† {product['price']} Ø±ÙŠØ§Ù„">
    <meta property="og:image" content="{product['image_link']}">
    <title>{product['title']} | Ø§Ù„Ø³ÙˆÙ‚ Ø§Ù„Ø³Ø¹ÙˆØ¯ÙŠ</title>

    <!-- Schema.org Product -->
    <script type="application/ld+json">
    {{
        "@context": "https://schema.org/",
        "@type": "Product",
        "name": "{product['title']}",
        "image": "{product['image_link']}",
        "description": "{product['title']} - Ø§Ù„Ø³Ø¹Ø± {product['sale_price']} Ø±ÙŠØ§Ù„ Ø¨Ø¯Ù„Ø§Ù‹ Ù…Ù† {product['price']} Ø±ÙŠØ§Ù„",
        "sku": "PROD-{product['id']}",
        "offers": {{
            "@type": "Offer",
            "url": "{product_url}",
            "priceCurrency": "SAR",
            "price": "{product['sale_price']}",
            "priceValidUntil": "2025-12-31",
            "availability": "https://schema.org/InStock"
        }}
    }}
    </script>

    <style>
        * {{
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }}
        
        body {{
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            direction: rtl;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }}
        
        .container {{
            max-width: 1000px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            overflow: hidden;
        }}
        
        .product-header {{
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }}
        
        .product-header h1 {{
            font-size: 28px;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.2);
        }}
        
        .product-content {{
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            padding: 30px;
        }}
        
        .product-image {{
            text-align: center;
        }}
        
        .product-image img {{
            max-width: 100%;
            height: auto;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }}
        
        .product-details {{
            display: flex;
            flex-direction: column;
            justify-content: center;
            gap: 20px;
        }}
        
        .price-box {{
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            padding: 20px;
            border-radius: 10px;
            color: white;
            text-align: center;
        }}
        
        .sale-price {{
            font-size: 48px;
            font-weight: bold;
            margin: 10px 0;
        }}
        
        .original-price {{
            font-size: 24px;
            text-decoration: line-through;
            opacity: 0.8;
        }}
        
        .discount {{
            background: #ff4757;
            color: white;
            padding: 10px 20px;
            border-radius: 25px;
            font-weight: bold;
            display: inline-block;
            margin-top: 10px;
        }}
        
        .whatsapp-btn {{
            background: #25D366;
            color: white;
            padding: 20px;
            text-align: center;
            border-radius: 10px;
            text-decoration: none;
            font-size: 20px;
            font-weight: bold;
            display: block;
            transition: all 0.3s ease;
            box-shadow: 0 5px 15px rgba(37, 211, 102, 0.4);
        }}
        
        .whatsapp-btn:hover {{
            background: #128C7E;
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(37, 211, 102, 0.6);
        }}
        
        .product-id {{
            background: #f8f9fa;
            padding: 10px;
            border-radius: 5px;
            text-align: center;
            color: #666;
            font-size: 14px;
        }}
        
        @media (max-width: 768px) {{
            .product-content {{
                grid-template-columns: 1fr;
            }}
            
            .sale-price {{
                font-size: 36px;
            }}
            
            .original-price {{
                font-size: 20px;
            }}
        }}
    </style>
</head>
<body>
    <div class="container">
        <div class="product-header">
            <h1>{product['title']}</h1>
            <p>Ù…Ù†ØªØ¬ Ø£ØµÙ„ÙŠ - Ø¶Ù…Ø§Ù† Ø§Ù„Ø¬ÙˆØ¯Ø©</p>
        </div>
        
        <div class="product-content">
            <div class="product-image">
                <img src="{product['image_link']}" alt="{product['title']}" loading="lazy">
            </div>
            
            <div class="product-details">
                <div class="price-box">
                    <div>Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ø®Ø§Øµ</div>
                    <div class="sale-price">{product['sale_price']} Ø±ÙŠØ§Ù„</div>
                    <div class="original-price">{product['price']} Ø±ÙŠØ§Ù„</div>
                    <div class="discount">ÙˆÙÙ‘Ø± {discount} Ø±ÙŠØ§Ù„ ({discount_percentage}% Ø®ØµÙ…)</div>
                </div>
                
                <a href="https://wa.me/{WHATSAPP_NUMBER}?text=Ù…Ø±Ø­Ø¨Ø§Ù‹ØŒ Ø£Ø±ÙŠØ¯ Ø§Ù„Ø§Ø³ØªÙØ³Ø§Ø± Ø¹Ù† Ø§Ù„Ù…Ù†ØªØ¬: {product['title']}" 
                   class="whatsapp-btn" target="_blank">
                    ğŸ“± Ø§Ø·Ù„Ø¨ Ø§Ù„Ø¢Ù† Ø¹Ø¨Ø± ÙˆØ§ØªØ³Ø§Ø¨
                </a>
                
                <div class="product-id">
                    Ø±Ù‚Ù… Ø§Ù„Ù…Ù†ØªØ¬: PROD-{product['id']}
                </div>
            </div>
        </div>
    </div>
</body>
</html>"""
    
    return html

def upload_to_github(file_path, content, message):
    """Ø±ÙØ¹ Ù…Ù„Ù Ø¥Ù„Ù‰ GitHub Ù…Ø¨Ø§Ø´Ø±Ø©"""
    if not GITHUB_TOKEN:
        print(f"âŒ Ø®Ø·Ø£: Ù„Ù… ÙŠØªÙ… ØªØ¹ÙŠÙŠÙ† GITHUB_TOKEN")
        return False
    
    api_url = f"https://api.github.com/repos/{GITHUB_REPO}/contents/{file_path}"
    headers = {
        'Authorization': f'token {GITHUB_TOKEN}',
        'Accept': 'application/vnd.github.v3+json'
    }
    
    try:
        response = requests.get(api_url, headers=headers)
        if response.status_code == 200:
            sha = response.json()['sha']
        else:
            sha = None
    except:
        sha = None
    
    data = {
        'message': message,
        'content': base64.b64encode(content.encode('utf-8')).decode('utf-8'),
        'branch': GITHUB_BRANCH
    }
    
    if sha:
        data['sha'] = sha
    
    try:
        response = requests.put(api_url, headers=headers, json=data)
        if response.status_code in [200, 201]:
            return True
        else:
            print(f"âŒ Ø®Ø·Ø£ ÙÙŠ Ø±ÙØ¹ {file_path}: {response.json()}")
            return False
    except Exception as e:
        print(f"âŒ Ø®Ø·Ø£: {str(e)}")
        return False


def main():
    print("â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—")
    print("â•‘     ğŸš€ Ø³ÙƒØ±Ø¨Øª ØªÙˆÙ„ÙŠØ¯ ØµÙØ­Ø§Øª Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª - Ø§Ù„Ø³ÙˆÙ‚ Ø§Ù„Ø³Ø¹ÙˆØ¯ÙŠ       â•‘")
    print("â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•")
    print()
    
    try:
        with open(PRODUCTS_FILE, 'r', encoding='utf-8') as f:
            content = f.read().strip()
            
            try:
                products = json.loads(content)
                if isinstance(products, dict):
                    products = [products]
            except json.JSONDecodeError:
                products = []
                for line in content.split('\n'):
                    line = line.strip().rstrip(',')
                    if line and line.startswith('{'):
                        try:
                            product = json.loads(line)
                            products.append(product)
                        except json.JSONDecodeError as e:
                            continue
            
            if not isinstance(products, list):
                products = [products]
        
        if not products:
            print(f"âŒ Ø®Ø·Ø£: Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ù…Ù†ØªØ¬Ø§Øª ÙÙŠ Ø§Ù„Ù…Ù„Ù")
            print(f"ğŸ’¡ ØªÙ„Ù…ÙŠØ­: ØªØ­Ù‚Ù‚ Ù…Ù† Ø£Ù† Ø§Ù„Ù…Ù„Ù ÙŠØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ø¨ÙŠØ§Ù†Ø§Øª JSON ØµØ­ÙŠØ­Ø©")
            print(f"ğŸ“„ Ù…Ø«Ø§Ù„ Ù„Ù„ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„ØµØ­ÙŠØ­:")
            print(f'[')
            print(f'  {{"id": 1, "title": "Ù…Ù†ØªØ¬", "price": 100, "sale_price": 80, "image_link": "https://..."}}')
            print(f']')
            return
            
        print(f"âœ… ØªÙ… ØªØ­Ù…ÙŠÙ„ {len(products)} Ù…Ù†ØªØ¬ Ù…Ù† {PRODUCTS_FILE}")
    except FileNotFoundError:
        print(f"âŒ Ø®Ø·Ø£: Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„Ù…Ù„Ù {PRODUCTS_FILE}")
        return
    except json.JSONDecodeError as e:
        print(f"âŒ Ø®Ø·Ø£ ÙÙŠ Ù‚Ø±Ø§Ø¡Ø© JSON: {str(e)}")
        print(f"ğŸ’¡ ØªÙ„Ù…ÙŠØ­: ØªØ£ÙƒØ¯ Ù…Ù† Ø£Ù† Ø§Ù„Ù…Ù„Ù ÙŠØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ù…ØµÙÙˆÙØ© JSON ØµØ­ÙŠØ­Ø©")
        return
    except Exception as e:
        print(f"âŒ Ø®Ø·Ø£ ØºÙŠØ± Ù…ØªÙˆÙ‚Ø¹: {str(e)}")
        return
    
    success_count = 0
    fail_count = 0
    
    print()
    print("ğŸ“¦ Ø¨Ø¯Ø¡ ØªÙˆÙ„ÙŠØ¯ ÙˆØ±ÙØ¹ Ø§Ù„ØµÙØ­Ø§Øª...")
    print("â”€" * 60)
    
    for idx, product in enumerate(products, 1):
        slug = create_slug(product['title'])
        file_path = f"{OUTPUT_DIR}/{slug}.html"
        
        try:
            html_content = generate_product_html(product)
            
            if upload_to_github(
                file_path, 
                html_content, 
                f"Ø¥Ø¶Ø§ÙØ© ØµÙØ­Ø© Ù…Ù†ØªØ¬: {product['title']}"
            ):
                success_count += 1
                print(f"âœ… [{idx}/{len(products)}] {product['title'][:50]}...")
            else:
                fail_count += 1
                print(f"âŒ [{idx}/{len(products)}] ÙØ´Ù„: {product['title'][:50]}...")
        
        except Exception as e:
            fail_count += 1
            print(f"âŒ [{idx}/{len(products)}] Ø®Ø·Ø£: {str(e)}")
    
    print()
    print("â”€" * 60)
    print("â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—")
    print("â•‘                    ğŸ“Š Ø§Ù„Ù†ØªÙŠØ¬Ø© Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ©                    â•‘")
    print("â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£")
    print(f"â•‘  âœ… Ù†Ø¬Ø­: {success_count:4d} ØµÙØ­Ø©                              â•‘")
    print(f"â•‘  âŒ ÙØ´Ù„: {fail_count:4d} ØµÙØ­Ø©                               â•‘")
    print(f"â•‘  ğŸ“ Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹: {len(products):4d} ØµÙØ­Ø©                         â•‘")
    print("â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•")
    print()
    print(f"ğŸŒ Ø±Ø§Ø¨Ø· Ø§Ù„Ù…ÙˆÙ‚Ø¹: https://github.com/{GITHUB_REPO}")

if __name__ == "__main__":
    main()